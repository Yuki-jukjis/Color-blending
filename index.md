# 合成モード解説

Adobe Photoshop CC準拠。  
二枚のレイヤーを合成するときの計算式（C言語風）と、その性質について解説します。    
3枚以上のレイヤの合成は一番下の2枚を計算してから、その結果を下のレイヤーとして対して3枚目を合成し、その結果に4枚目を……という手順のはずです。ちなみにレイヤーを結合するときに下から順にやらないと結果が変わってしまうのはこのせい。    

ここではxが下のレイヤーの色、yが上のレイヤーの色、zが計算結果の色とします。これらはそれぞれ色を表す構造体で、r,g,b,aのメンバーを持ちます。  
例えば、x.rは下のレイヤーの赤(red)、x.gは緑(green)、x.bは青(blue)、x.aは不透明度(alpha)の値です。y,zについても同様。  
それぞれの値は0～1の小数値とします（Adobeの引用の中では0～255になってますが、計算が面倒なので）。  

## 透明度系  

### 通常  

> 各ピクセルを編集またはペイントして結果色を作成します。これは、初期設定のモードです（通常モードは、モノクロ 2 階調画像やインデックスカラー画像で作業するときには、2 階調化と呼ばれます）。  

```  
z.r = y.r * y.a + x.r * (1 - y.a);  
z.g = y.g * y.a + x.g * (1 - y.a);  
z.b = y.b * y.a + x.b * (1 - y.a);  
z.a = y.a + x.a * (1 - y.a);  
```  

![通常合成のグラフ](plots/normal.png)  

![通常合成のサンプル](samples/normal.png)  

地味に一番厄介かもしれません。y.a、つまり上のレイヤーの不透明度に準じてrgbを線形補完している式です。  

y.aが1なら z = y と同じです。xに関わらず上のレイヤで完全に上書きするだけ。  

### ディザ合成  

> 各ピクセルを編集またはペイントして結果色を作成します。ディザ合成モードの結果色は、ピクセルの不透明度に応じて基本色や合成色でランダムに置き換えられます。  

```  
if(y.a < random()){  
  z = x;  
} else {  
  z = y;  
}  
```  

ここでrandom()は0以上1未満の一様分布乱数を返すとしましょう。  
乱数でどちらの色を採用するかか決めます。y.a（上の不透明度）が高いほどyが選ばれる確率が上がります。  

## 必ず暗くなる系  

ここから下はy.a=1として、不透明度についてのについての解説を省きます。  

### 比較（暗）  

> 各チャンネル内のカラー情報に基づき、基本色または合成色のいずれか暗い方を結果色として選択します。合成色よりも明るいピクセルが置き換えられ、合成色よりも暗いピクセルは変更されません。  

```  
z.r = min(x.r, y.r);  
z.g = min(x.g, y.g);  
z.b = min(x.b, y.b);  
```  

rgbそれぞれで、xとyの小さい方の値を採用します。  

![比較（暗）のグラフ](plots/darken.png)  
![比較（暗）のサンプル](samples/darken.png)  

### 乗算  

> 各チャンネル内のカラー情報に基づき、基本色と合成色を乗算します。結果色は暗いカラーになります。どのカラーも、ブラックで乗算すると結果はブラックになります。どのカラーも、ホワイトで乗算した場合は変更されません。ブラックまたはホワイト以外のカラーでペイントしている場合、ペイントツールで繰り返しストロークを描くとカラーは徐々に暗くなります。この効果は、複数のマーカーペンで描画したような効果が得られます。  

```  
z = x * y;  
```  

xとyの値を単純に掛け算します。スクリーンの双対です。  
xが1のときはyの値そのままに、yが1のときはxの値そのままになります。また、xとyどちらか一方が0だと必ず0になります。  


![乗算のグラフ](plots/multiply.png)  
![乗算のサンプル](samples/multiply.png)  

### 焼き込みカラー  

> 各チャンネルのカラー情報に基づき、基本色を暗くして基本色と合成色のコントラストを強くし、合成色を反映します。ホワイトで合成した場合は、何も変更されません。  

```  
z = 1 - (1 - x) / y;  
```  

覆い焼きカラーの双対です。  
xが1のときはyの色そのままになります。  


![焼き込みカラーのグラフ](plots/burn_color.png)  
![焼き込みカラーのサンプル](samples/burn_color.png)  

### 焼き込み（リニア）  

> 各チャンネル内のカラー情報に基づき、基本色を暗くして明るさを落とし、合成色を反映します。ホワイトで合成した場合は、何も変更されません。  

```  
z = x + y - 1;  
```  

覆い焼きリニア（加算）の双対です。  
x - (1 - y)の方が分かりやすいかもしれません。上のレイヤが白から離れた分暗くします。  

![焼き込みリニアのグラフ](plots/burn_linear.png)  
![焼き込みリニアのサンプル](samples/burn_linear.png)  

### カラー比較（暗）  

> 合成色と基本色について、すべてのチャンネル値の合計を比較し、値が低い方の色を表示します。カラー比較（暗）モードでは、基本色と合成色の両方のチャンネル値のうち最も低いものを選択することによって結果色が作成されるので、比較（暗）モードと異なり 3 番目の色は生成されません。  

```  
if(0.3 * x.r + 0.6 * x.g + 0.1 * x.b <  
  0.3 * y.r + 0.6 * y.g + 0.1 * y.b) {  
  z = x;  
}  
else {  
  z = y;  
}  
```  

xとyそれぞれのrgbの値を3:6:1くらいで混ぜて足し、xの方が小さかったらxを、yのほうが小さかったらyを採用します。  
つまり出力は(不透明度が1なら)必ずxとyどちらかの色になります。  


## 必ず明るくなる系  

### 比較（明）  

> 各チャンネル内のカラー情報に基づき、基本色または合成色のいずれか明るい方を結果色として選択します。合成色よりも暗いピクセルが置き換えられ、合成色よりも明るいピクセルは変更されません。  


![比較（明）のグラフ](plots/lighten.png)  
![比較（明）のサンプル](samples/lighten.png)  

### スクリーン  

> 各チャンネル内のカラー情報に基づき、合成色と基本色を反転したカラーを乗算します。結果色は明るいカラーになります。ブラックでスクリーニングすると、カラーは変更されません。ホワイトでスクリーニングすると、ホワイトになります。この効果は、複数の写真スライドを重ね合わせて投影したような効果が得られます。  

```  
z = 1 - (1 - x) * (1 - y);  
```  

乗算の双対です。  
xが0のときはyの値そのままに、yが0のときはxの値そのままになります。また、xとyどちらか一方が1だと必ず1になります。  


![スクリーンのグラフ](plots/screen.png)  
![スクリーンのサンプル](samples/screen.png)  

### 覆い焼きカラー  

> 各チャンネルのカラー情報に基づき、基本色を明るくして基本色と合成色のコントラストを落とし、合成色を反映します。ブラックと合成しても変化はありません。  

```  
z = x / (1 - y)  
```  

焼き込みカラーの双対です。  


![覆い焼きカラーのグラフ](plots/dodge_color.png)  
![覆い焼きカラーのサンプル](samples/dodge_color.png)  

### 覆い焼き（リニア）- 加算  

> 各チャンネル内のカラー情報に基づき、基本色を明るくして明るさを増し、合成色を反映します。ブラックと合成しても変化はありません。  

```  
z = x + y  
```  

xとyを単純に足します。焼き込みリニアの双対です  

![覆い焼きリニアのグラフ](plots/dodge_linear.png)  
![覆い焼きリニアのサンプル](samples/dodge_linear.png)  

### カラー比較（明）  

> 合成色と基本色について、すべてのチャンネル値の合計を比較し、値が高い方の色を表示します。カラー比較（明）モードでは、基本色と合成色の両方のチャンネル値のうち最も高いものを選択することによって結果色が作成されるので、比較（明）モードと異なり 3 番目の色は生成されません。  

## コントラスト上げる系  

オーバーレイは下の、それ以外は上のレイヤーの値を基準に条件分岐し、明るい色の時は明るくする系の合成を、暗い色の時はより暗くする系の合成をします。  

### オーバーレイ  

> 基本色に応じて、カラーを乗算またはスクリーンします。基本色のハイライトおよびシャドウを保持しながら、パターンまたはカラーを既存のピクセルに重ねます。基本色は、置き換えられませんが、合成色と混合されて基本色の明るさまたは暗さを反映します。  

```  
if(x < 0.5) {  
  z = 2 * x * y;  
} else {  
  z = 1 - 2 * (1 - x) * (1 - y);  
}  
```  

x、つまり下のレイヤーの値が0.5未満のときは乗算に、0.5以上のときはスクリーンになります。  
ただし、乗算するときはxの0～0.5を0～1にマッピングしなおしたものを乗算し、スクリーンするときは0.5～1を0～1にマッピングしなおしたものをスクリーンします（式中で2倍してますね）。  

なお、コントラスト上げる系の中で下のレイヤを基準に分岐するのはオーバーレイだけです。  

![オーバーレイのグラフ](plots/overlay.png)  
![オーバーレイのサンプル](samples/overlay.png)  

### ソフトライト  

> 合成色に応じて、カラーを暗くまたは明るくします。画像上でスポットライトを照らしたような効果が得られます。合成色（光源）が 50 ％グレーよりも明るい場合、画像は覆い焼きされたかのように明るくなります。合成色が 50 ％グレーよりも暗い場合、画像は焼き込んだように暗くなります。純粋な黒または白でペイントすると、その部分の明暗ははっきりしますが、純粋な黒または白にはなりません。  

ソフトライトは対応する明るくする系や暗くする系の合成モードがありません。

![ソフトライトのグラフ](plots/softlight.png)  
![ソフトライトのサンプル](samples/softlight.png)  


### ハードライト  

> 合成色に応じて、カラーを乗算またはスクリーンします。画像上で直接スポットライトを照らしたような効果が得られます。合成色（光源）が 50 ％グレーよりも明るい場合、画像はスクリーンされたかのように明るくなります。これは、画像にハイライトを追加するときに役立ちます。合成色が 50 ％グレーよりも暗い場合、画像は乗算されたかのように暗くなります。これは、画像にシャドウを追加するときに役立ちます。純粋なホワイトまたはブラックでペイントすると、純粋なホワイトまたはブラックになります。  

```  
if(y < 0.5) {  
  z = x * y * 2;  
} else {  
  z = 1 - 2 * (1-x) * (1-y);    
}  
```  

判定に使うのが上のレイヤになった以外、オーバーレイと同じです。  
yが0のときはzも0、yが1のときはzも1、yが0.5のときはzはxの値そのままになります。  

![ハードライトのグラフ](plots/hardlight.png)  
![ハードライトのサンプル](samples/hardlight.png)  

### ビビッドライト  

> 合成色に応じてコントラストを増加または減少させ、カラーの焼き込みまたは覆い焼きを行います。合成色（光源）が 50 ％グレーより明るい場合は、コントラストを落として画像を明るくします。合成色が 50 ％グレーより暗い場合は、コントラストを上げて画像を暗くします。  

```
if(y < 0.5)
  z = 1 - (1 - x) / (2 * y)
else
  z = x / (2 - 2 * y)
```

yが0.5未満のときは焼き込みカラーのように、0.5以上のときは覆い焼きカラーのように合成します。  
yが0のときはzも0、yが1のときはzも1、yが0.5のときはzはxの値そのままになります。  

![ビビッドライトのグラフ](plots/vividlight.png)  
![ビビッドライトのサンプル](samples/vividlight.png)  

### リニアライト  

> 合成色に応じて明るさを減少または増加させ、カラーの焼き込みまたは覆い焼きを行います。合成色（光源）が 50 ％グレーより明るい場合は、明るさを増して画像を明るくします。合成色が 50 ％グレーより暗い場合は、明るさを落として画像を暗くします。  

```
z = x + 2 * y - 1
```

上のレイヤーが0.5未満のときは焼き込みリニアのように、0.5以上のときは覆い焼きリニアのように合成します。……が、これは条件分岐なしで書けます。

![リニアライトのグラフ](plots/linearlight.png)  
![リニアライトのサンプル](samples/linearlight.png)  

### ピンライト  

> 合成色に応じて、カラーが置換されます。合成色（光源）が 50 ％グレーより明るい場合、合成色より暗いピクセルは置換されます。合成色より明るいピクセルは、変更されません。合成色が 50 ％グレーより暗い場合、合成色より明るいピクセルは置換されます。合成色より暗いピクセルは変更されません。これは、画像に特殊効果を追加するときに役立ちます。  

```
if(y < 0.5)
  z = min(x, 2 * y);
else
  z = max(x, 2 * y - 1);
```

上のレイヤーが0.5未満のときは比較（暗）のように、0.5以上のときは比較（明）のように合成します。

![ピンライトのグラフ](plots/pinlight.png)  
![ピンライトのサンプル](samples/pinlight.png)  

### ハードミックス  

> 合成色のレッド、グリーンおよびブルーの各チャンネル値を基本色の RGB 値に追加します。合計が 255 以上のチャンネルは、値 255 を受け取り、合計が 255 未満のチャンネルは、値 0 を受け取ります。したがって、合成されるすべてのピクセルに、0 または 255 のいずれかの RGB 値が割り当てられます。これにより、全ピクセルが加法原色（赤、緑または青）、白または黒に変わります。  

```  
if(x + y < 1) {  
  z = 0;  
} else {  
  z = 1;    
}  
```  

![ハードミックスのグラフ](plots/hardmix.png)  
![ハードミックスのサンプル](samples/hardmix.png)  


## その他  

### 差の絶対値  

> 各チャンネル内のカラー情報に基づいて、合成色を基本色から取り除くか、基本色を合成色から取り除きます。明るさの値の大きい方のカラーから小さい方のカラーを取り除きます。ホワイトと合成すると基本色の値が反転しますが、ブラックと合成しても変化はありません。  

### 除外  

> 差の絶対値モードと似ていますが、効果のコントラストはより低くなります。ホワイトと合成すると、基本色の値が反転しますが、ブラックと合成しても変化はありません。  

### 減算  

> 各チャンネル内のカラー情報に基づき、基本色から合成色を減算します。8 ビットおよび 16 ビット画像で、結果の負の値が 0 にクリッピングされます。  

### 除算  

> 各チャンネル内のカラー情報に基づき、基本色と合成色を分けます。  

### 色相  

> ベースカラーの輝度と彩度、およびブレンドカラーの色相を持つ最終カラーが作成されます。  

### 彩度  

> 基本色の輝度と色相および合成色の彩度を使用して、結果色を作成します。このモードで彩度ゼロ（グレー）の領域をペイントした場合は、何も変更されません。  

### カラー  

> 基本色の輝度と、合成色の色相および彩度を使用して、結果色を作成します。これにより、画像内のグレーレベルが保持され、モノクロ画像のカラー化およびカラー画像の階調化に役立ちます。  

### 輝度  

> 基本色の色相および彩度と、合成色の輝度を使用して、結果色を作成します。このモードでは、カラーモードの反対の効果が作成されます。  
